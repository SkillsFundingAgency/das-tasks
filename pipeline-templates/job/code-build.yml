parameters:
  SolutionBaseName:
  BuildConfiguration:
  BuildPlatform:

jobs:
- job: CodeBuild
  variables:
  - group: BUILD Management Resources
  steps:
    - task: gitversion/setup@0
      displayName: gitversion/setup
      inputs:
        versionSpec: 5.x

    - task: gitversion/execute@0
      displayName: gitversion/execute
      inputs:
        useConfigFile: true
        configFilePath: GitVersion.yml

    - task: NuGetCommand@2
      displayName: Restore
      inputs:
        command: 'restore'
        restoreSolution: '**/*.sln'

    - task: VSBuild@1
      displayName: Build
      inputs:
        solution: '**/*.sln'
        configuration: ${{ parameters.BuildConfiguration }}
        platform: ${{ parameters.BuildPlatform }}

    - task: VSTest@2
      displayName: Unit Tests
      inputs:
        testSelector: 'testAssemblies'
        testAssemblyVer2: | 
          **\*UnitTests.dll
          !**\*TestAdapter.dll
          !**\obj\** 
        configuration: ${{ parameters.BuildConfiguration }}
        platform: ${{ parameters.BuildPlatform }}

    - template: azure-pipelines-templates/build/step/dependency-check.yml@das-platform-building-blocks

    - task: VSBuild@1
      displayName: 'Publish API'
      inputs:
        solution: src/SFA.DAS.Tasks.API/SFA.DAS.Tasks.API.csproj
        vsVersion: '16.0'
        msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactstagingdirectory)/publish/SFA.DAS.Tasks.API/"'
        platform: 'anycpu'
        configuration: '$(buildConfiguration)'
        clean: true

    - task: VSBuild@1
      displayName: 'Publish Worker'
      inputs:
        solution: src\SFA.DAS.Tasks.Worker\SFA.DAS.Tasks.Worker.csproj
        vsVersion: '16.0'
        msbuildArgs: '/p:SkipInvalidConfigurations=true /p:OutputPath="$(build.artifactstagingdirectory)/publish/SFA.DAS.Tasks.Worker/"'
        platform: 'anycpu'
        configuration: '$(buildConfiguration)'
        clean: true

    - task: VSBuild@1
      displayName: 'Publish Acceptance Tests'
      inputs:
        solution: src\SFA.DAS.Tasks.AcceptanceTests\SFA.DAS.Tasks.AcceptanceTests.csproj
        vsVersion: '16.0'
        msbuildArgs: '/p:SkipInvalidConfigurations=true /p:OutputPath="$(build.artifactstagingdirectory)/publish/SFA.DAS.Tasks.AcceptanceTests/"'
        platform: 'anycpu'
        configuration: '$(buildConfiguration)'
        clean: true

    - task: CopyFiles@2
      displayName: Copy Files to $(build.artifactstagingdirectory)/publish
      inputs:
        Contents: |
          azure/**
        TargetFolder: $(build.artifactstagingdirectory)/publish
        OverWrite: true

    - task: PublishPipelineArtifact@1
      displayName: Publish Artifact SFA.DAS.Tasks
      inputs:
        targetPath: $(build.artifactstagingdirectory)/publish
        artifactName: SFA.DAS.Tasks

    - template: azure-pipelines-templates/build/step/nuget-pack.yml@das-platform-building-blocks
      parameters: 
        DotNetFrameworkPackagesToPack: |
          src\SFA.DAS.Tasks.API.Client\SFA.DAS.Tasks.API.Client.csproj
